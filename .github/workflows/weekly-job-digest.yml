name: Weekly Job Digest

on:
  schedule:
    - cron: "0 9 * * MON"   # every Monday at 09:00 UTC
  workflow_dispatch:         # manual trigger

jobs:
  digest:
    runs-on: ubuntu-latest

    steps:
      - name: Run weekly digest
        uses: actions/github-script@v7
        with:
          script: |
            const fetch = global.fetch;

            const SHARETRIBE_BASE = "https://flex-api.sharetribe.com/v1";
            const TEST_MODE = process.env.TEST_MODE === "true";

            function log(...args) {
              console.log(...args);
            }

            async function getSharetribeToken() {
              const res = await fetch(`${SHARETRIBE_BASE}/auth/token`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/x-www-form-urlencoded; charset=utf-8",
                  Accept: "application/json"
                },
                body: new URLSearchParams({
                  client_id: process.env.SHARETRIBE_CLIENT_ID,
                  grant_type: "password",
                  username: process.env.SHARETRIBE_USERNAME,
                  password: process.env.SHARETRIBE_PASSWORD,
                  scope: "user"
                })
              });

              const text = await res.text();
              log("TOKEN STATUS:", res.status);
              log("TOKEN BODY:", text);

              if (!res.ok) throw new Error(`Token failed: ${res.status} ${text}`);
              return JSON.parse(text).access_token;
            }

            async function paginate(token, url, body) {
              let results = [];
              let cursor = null;

              do {
                const res = await fetch(url, {
                  method: "POST",
                  headers: {
                    Authorization: `bearer ${token}`,
                    "Content-Type": "application/json"
                  },
                  body: JSON.stringify({
                    ...body,
                    limit: 50,
                    cursor
                  })
                });

                const data = await res.json();
                if (!data.data) break;

                results = results.concat(data.data);
                cursor = data.links?.next?.cursor || null;

              } while (cursor);

              return results;
            }

            async function getJobs(token) {
              const since = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
              return await paginate(token, `${SHARETRIBE_BASE}/listings/query`, {
                listingType: "job",
                createdAtStart: since,
                states: ["published"]
              });
            }

            async function getConsultants(token) {
              return await paginate(token, `${SHARETRIBE_BASE}/users/query`, {
                userType: "consultant"
              });
            }

            async function getListingById(token, id) {
              const res = await fetch(`${SHARETRIBE_BASE}/listings/${id}`, {
                headers: { Authorization: `bearer ${token}` }
              });
              const data = await res.json();
              return data.data;
            }

            async function getSendPulseToken() {
              const res = await fetch("https://api.sendpulse.com/oauth/access_token", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  grant_type: "client_credentials",
                  client_id: process.env.SENDPULSE_CLIENT_ID,
                  client_secret: process.env.SENDPULSE_CLIENT_SECRET
                })
              });
              const data = await res.json();
              if (!data.access_token) throw new Error("SendPulse token failed: " + JSON.stringify(data));
              return data.access_token;
            }

            async function sendEmail(token, to, subject, html) {
              if (TEST_MODE) {
                log("[TEST MODE] Email would be sent to:", to);
                log("[TEST MODE] Subject:", subject);
                log("[TEST MODE] HTML:", html);
                return;
              }

              const res = await fetch("https://api.sendpulse.com/smtp/emails", {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${token}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  email: {
                    subject,
                    html,
                    from: { name: "Job Alerts", email: process.env.FROM_EMAIL },
                    to: [{ email: to }]
                  }
                })
              });

              const data = await res.json();
              if (!res.ok) throw new Error("SendPulse email failed: " + JSON.stringify(data));
            }

            function matchJobs(consultantRoles, jobs) {
              return jobs.filter(job => {
                const jobRoles = job.attributes.publicData?.roles || [];
                return jobRoles.some(r => consultantRoles.includes(r));
              });
            }

            async function main() {
              log("Starting weekly digest...");

              const token = await getSharetribeToken();
              const jobs = await getJobs(token);
              const consultants = await getConsultants(token);

              if (!jobs.length) {
                log("No jobs this week.");
                return;
              }

              const spToken = await getSendPulseToken();
              let sent = 0;

              for (const user of consultants) {
                const email = user.attributes.email;
                if (!email) continue;

                const latestListingId = user.attributes.publicData?.latestListing;
                if (!latestListingId) continue;

                const profileListing = await getListingById(token, latestListingId);
                const roles = profileListing.attributes.publicData?.roles || [];

                const matches = matchJobs(roles, jobs);
                if (!matches.length) continue;

                const html = `
                  <p>Hi ${user.attributes.profile?.displayName || "Consultant"},</p>
                  <p>Here are ${matches.length} matching jobs from this week:</p>
                  <ul>
                    ${matches.map(j => `<li>${j.attributes.title}</li>`).join("")}
                  </ul>
                `;

                await sendEmail(spToken, email, "Weekly Job Digest", html);
                sent++;
              }

              log("Finished. Emails sent:", sent);
            }

            await main();

        env:
          SHARETRIBE_CLIENT_ID: ${{ secrets.SHARETRIBE_CLIENT_ID }}
          SHARETRIBE_USERNAME: ${{ secrets.SHARETRIBE_USERNAME }}
          SHARETRIBE_PASSWORD: ${{ secrets.SHARETRIBE_PASSWORD }}
          SENDPULSE_CLIENT_ID: ${{ secrets.SENDPULSE_CLIENT_ID }}
          SENDPULSE_CLIENT_SECRET: ${{ secrets.SENDPULSE_CLIENT_SECRET }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          TEST_MODE: ${{ secrets.TEST_MODE }}
