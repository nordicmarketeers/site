name: Weekly Job Digest

on:
  workflow_dispatch:      # Manual trigger
  schedule:
    - cron: "0 0 * * 0"   # Weekly (Sunday 00:00 UTC)

jobs:
  digest:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch Sharetribe token
        id: token
        run: |
          TOKEN=$(curl -s -X POST "https://flex-api.sharetribe.com/v1/auth/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials&client_id=${{ secrets.SHARETRIBE_CLIENT_ID }}&client_secret=${{ secrets.SHARETRIBE_CLIENT_SECRET }}" \
            | python -c "import sys, json; print(json.load(sys.stdin)['access_token'])")

          echo "TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Fetch job listings
        id: jobs
        run: |
          JOBS=$(curl -s "https://flex-integ-api.sharetribe.com/v1/integration_api/listings/query?listingType=job&limit=50" \
            -H "Authorization: bearer $TOKEN")

          echo "JOBS<<EOF" >> $GITHUB_ENV
          echo "$JOBS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Fetch consultant profiles
        id: consultants
        run: |
          CONSULTANTS=$(curl -s "https://flex-integ-api.sharetribe.com/v1/integration_api/listings/query?listingType=consultant_profile&limit=50" \
            -H "Authorization: bearer $TOKEN")

          echo "CONSULTANTS<<EOF" >> $GITHUB_ENV
          echo "$CONSULTANTS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Match jobs to consultants
        id: match
        run: |
          JOBS="$JOBS"
          CONSULTANTS="$CONSULTANTS"

          # Extract roles from jobs
          # (This assumes your job listing roles are in publicData.role array)
          # Adjust if your field name is different (e.g., publicData.roles)
          JOB_ROLES=$(echo "$JOBS" | jq -r '.data[] | .attributes.publicData.role[]' | sort | uniq)

          # Create a JSON array of matched consultants
          MATCHED=$(echo "$CONSULTANTS" | jq --argjson roles "$(echo "$JOB_ROLES" | jq -R . | jq -s .)" '
            .data[] |
            select(
              (.attributes.publicData.role // []) as $cRoles |
              ($roles | any(. == $cRoles[]))
            )
          ')

          # Extract emails from matched consultants
          # IMPORTANT: Your consultant listing must include the user email in publicData or relationships
          # If emails are in user relationship, you need another API call.
          EMAILS=$(echo "$MATCHED" | jq -r '.attributes.publicData.email // empty' | sort | uniq)

          echo "MATCHED<<EOF" >> $GITHUB_ENV
          echo "$MATCHED" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "EMAILS=$EMAILS" >> $GITHUB_ENV

      - name: Send emails (SendPulse)
        if: ${{ env.EMAILS != '' }}
        run: |
          SP_TOKEN=$(curl -s -X POST "https://api.sendpulse.com/oauth/access_token" \
            -H "Content-Type: application/json" \
            -d "{\"grant_type\":\"client_credentials\",\"client_id\":\"${{ secrets.SENDPULSE_CLIENT_ID }}\",\"client_secret\":\"${{ secrets.SENDPULSE_CLIENT_SECRET }}\"}" \
            | python -c "import sys, json; print(json.load(sys.stdin)['access_token'])")

          for email in $EMAILS; do
            curl -s -X POST "https://api.sendpulse.com/smtp/emails" \
              -H "Authorization: Bearer $SP_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{
                \"email\": {
                  \"subject\": \"Weekly Job Digest\",
                  \"html\": \"<p>Here are jobs matching your profile</p>\",
                  \"from\": {\"name\": \"Job Alerts\", \"email\": \"${{ secrets.FROM_EMAIL }}\"},
                  \"to\": [{\"email\": \"$email\"}]
                }
              }"
          done

          echo "Sent emails to: $EMAILS"

