      # 5. Send or preview using Brevo
      - name: Send weekly job digest emails (Brevo)
        if: always()
        env:
          RECIPIENTS_FILE: ${{ steps.match-and-prepare.outputs.recipients_file }}
          AGGREGATED_FILE: ${{ steps.match-and-prepare.outputs.aggregated_file }}
          RECIPIENT_COUNT: ${{ steps.match-and-prepare.outputs.recipient_count }}
        run: |
          echo "Outputs: recipients_file=$RECIPIENTS_FILE aggregated_file=$AGGREGATED_FILE count=$RECIPIENT_COUNT"

          if [[ -z "$RECIPIENTS_FILE" || ! -f "$RECIPIENTS_FILE" || ! -s "$RECIPIENTS_FILE" ]]; then
            echo "No recipients found — check matches above"
            ls -la *.csv *.txt || true
            exit 0
          fi

          echo "Recipients:"
          cat "$RECIPIENTS_FILE"

          if [[ "${{ secrets.TEST_MODE }}" == "true" ]]; then
            echo ""
            echo "TEST MODE — preview (Brevo):"

            while IFS='|' read -r email jobs_html; do
              echo "----------------------------------------"
              echo "To: $email"
              echo "Subject: Weekly Job Opportunities Matching Your Profile"
              echo ""
              echo "HTML:"
              echo "<h2>New matching jobs this week</h2>"
              echo "<p>We found the following jobs that match your roles:</p>"
              echo "<ul>${jobs_html:-<li>No jobs this week — check back next time!</li>}</ul>"
              echo "<p><a href=\"https://your-platform.com/search/jobs\">View all jobs →</a></p>"
              echo ""
            done < "$AGGREGATED_FILE"

            exit 0
          fi

          # Brevo transactional email sending — indented heredoc with <<-EOF
          while IFS='|' read -r email jobs_html; do
            # Escape for JSON
            escaped_html=$(printf '%s' "$jobs_html" | sed 's/[\\/"]/\\&/g')

            RESPONSE=$(curl -s -X POST "https://api.brevo.com/v3/smtp/email" \
              -H "accept: application/json" \
              -H "api-key: ${{ secrets.BREVO_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d @- <<-EOF
		{
		  "sender": {
		    "name": "${{ secrets.FROM_NAME }}",
		    "email": "${{ secrets.FROM_EMAIL }}"
		  },
		  "to": [{
		    "email": "$email"
		  }],
		  "subject": "Weekly Job Opportunities Matching Your Profile",
		  "htmlContent": "<h2>New matching jobs this week</h2><p>We found the following jobs that match your roles:</p><ul>$escaped_html</ul><p><a href=\"https://your-platform.com/search/jobs\">Browse all opportunities →</a></p><p>Best regards,<br>Your Platform Team</p>"
		}
		EOF
            )

            echo "$RESPONSE" | jq . 2>/dev/null || echo "Brevo raw response: $RESPONSE"

            if echo "$RESPONSE" | grep -q '"messageId"'; then
              echo "Sent successfully to $email"
            else
              echo "Failed to send to $email — check response above"
            fi

            sleep 1.2  # Gentle rate limiting
          done < "$AGGREGATED_FILE"

          echo "Brevo email sending completed."
