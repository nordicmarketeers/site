name: Weekly Job Digest

on:
  schedule:
    - cron: "0 9 * * 1"  # 9 AM UTC every Monday
  workflow_dispatch:

jobs:
  digest:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Fetch Sharetribe API Token
      - name: Fetch Sharetribe API Token
        id: fetch_token
        run: |
          echo "Fetching Sharetribe API token..."
          TOKEN=$(curl -s -X POST "https://flex-api.sharetribe.com/v1/auth/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials&client_id=${{ secrets.SHARETRIBE_CLIENT_ID }}&client_secret=${{ secrets.SHARETRIBE_CLIENT_SECRET }}" \
            | python -c "import sys, json; print(json.load(sys.stdin)['access_token'])")
          
          if [ -z "$TOKEN" ]; then
            echo "Failed to fetch Sharetribe token."
            exit 1
          fi
          
          echo "TOKEN=$TOKEN" >> $GITHUB_ENV

      # Step 2: Fetch Jobs from Sharetribe (Last 7 Days)
      - name: Fetch Jobs from Sharetribe (Last 7 Days)
        id: fetch_jobs
        run: |
          echo "Fetching jobs from Sharetribe..."
          SEVEN_DAYS_AGO=$(date -u -d "7 days ago" +"%Y-%m-%dT%H:%M:%SZ")

          JOBS=$(curl -s "https://flex-integ-api.sharetribe.com/v1/integration_api/listings/query?listingType=consultant_job&createdAtStart=$SEVEN_DAYS_AGO&limit=100" \
            -H "Authorization: bearer $TOKEN")
          
          if [ -z "$JOBS" ]; then
            echo "No jobs found."
            exit 1
          fi

          echo "JOBS<<EOF" >> $GITHUB_ENV
          echo "$JOBS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # Step 3: Fetch Approved Consultant Profiles from Sharetribe
      - name: Fetch Approved Consultant Profiles
        id: fetch_consultants
        run: |
          echo "Fetching approved consultant profiles..."
          CONSULTANTS=$(curl -s "https://flex-integ-api.sharetribe.com/v1/integration_api/listings/query?listingType=consultant_profile&publicData.approved=approved&limit=100" \
            -H "Authorization: bearer $TOKEN")

          if [ -z "$CONSULTANTS" ]; then
            echo "No consultants found."
            exit 1
          fi

          echo "CONSULTANTS<<EOF" >> $GITHUB_ENV
          echo "$CONSULTANTS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # Step 4: Match Jobs to Consultants Based on Roles and Profile Listings
      - name: Match Jobs to Consultants
        id: match_jobs
        run: |
          echo "Matching jobs to consultants..."
      
          # Iterate over each job listing and find matching consultants
          MATCHED_JOBS_AND_CONSULTANTS=""
          for job in $(echo "$JOBS" | jq -r '.data[] | @base64'); do
            _jq() {
              echo ${job} | base64 --decode | jq -r ${1}
            }
      
            JOB_ROLES=$(_jq '.attributes.publicData.role[]' | sort | uniq)
            JOB_ID=$(_jq '.id')
      
            # Debug: Check the roles being extracted from job
            echo "Job ID: $JOB_ID"
            echo "Job Roles: $JOB_ROLES"
      
            # Find matching consultants based on roles
            MATCHED_CONSULTANTS=$(echo "$CONSULTANTS" | jq --argjson roles "$(echo "$JOB_ROLES" | jq -R . | jq -s .)" '
              .data[] |
              select(
                # Ensure consultant has any role that matches a job role
                (.attributes.publicData.role // []) as $cRoles |
                any($cRoles[]; index($roles[])) != null and
                # Ensure consultant has a valid latestListing ID directly inside attributes
                .attributes.publicData.latestListing != null
              )
            ')
      
            # Debug: Check if consultants are being matched
            echo "Matched Consultants for Job $JOB_ID: $MATCHED_CONSULTANTS"
      
            if [ -n "$MATCHED_CONSULTANTS" ]; then
              # Collect the job and matched consultants
              MATCHED_JOBS_AND_CONSULTANTS=$(echo "$MATCHED_JOBS_AND_CONSULTANTS" | jq --arg job_id "$JOB_ID" --argjson matched_consultants "$MATCHED_CONSULTANTS" '
                . + [{"job_id": $job_id, "consultants": $matched_consultants}]
              ')
            fi
          done
      
          # Debugging matched jobs and consultants
          echo "Matched Jobs and Consultants: $MATCHED_JOBS_AND_CONSULTANTS"
      
          if [ -z "$MATCHED_JOBS_AND_CONSULTANTS" ]; then
            echo "No matching jobs and consultants found."
            exit 1
          fi
      
          echo "MATCHED_JOBS_AND_CONSULTANTS<<EOF" >> $GITHUB_ENV
          echo "$MATCHED_JOBS_AND_CONSULTANTS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

    
      # Step 5: Fetch User Emails for Matched Consultants (based on their latestListing)
      - name: Fetch Emails for Matched Consultants
        id: fetch_emails
        run: |
          echo "Fetching emails for matched consultants..."
          USER_EMAILS=""
          for consultant in $(echo "$MATCHED" | jq -r '.id'); do
            # Fetch the profile listing id from the consultant's latestListing field
            PROFILE_ID=$(echo "$consultant" | jq -r '.attributes.publicData.latestListing')

            # Fetch the user associated with the profile listing (Consultant)
            USER_ID=$(curl -s "https://flex-integ-api.sharetribe.com/v1/integration_api/listings/show?id=$PROFILE_ID" \
              -H "Authorization: bearer $TOKEN" | jq -r '.data.attributes.user.id')

            # Fetch the user's email
            USER_EMAIL=$(curl -s "https://flex-integ-api.sharetribe.com/v1/integration_api/users/show?id=$USER_ID" \
              -H "Authorization: bearer $TOKEN" | jq -r '.data.attributes.profile.publicData.email')

            if [ "$USER_EMAIL" != "null" ]; then
              USER_EMAILS="$USER_EMAILS $USER_EMAIL"
            fi
          done

          if [ -z "$USER_EMAILS" ]; then
            echo "No user emails found."
            exit 1
          fi

          echo "USER_EMAILS=$USER_EMAILS" >> $GITHUB_ENV

      # Step 6: Send Emails to Consultants (using SendPulse)
      - name: Send Emails to Consultants
        if: ${{ env.USER_EMAILS != '' }}
        id: send_emails
        run: |
          echo "Sending emails to consultants..."
          
          # Check if TEST_MODE is enabled
          if [ "${{ secrets.TEST_MODE }}" == "true" ]; then
            echo "[TEST MODE] Emails would be sent to: $USER_EMAILS"
          else
            SP_TOKEN=$(curl -s -X POST "https://api.sendpulse.com/oauth/access_token" \
              -H "Content-Type: application/json" \
              -d "{\"grant_type\":\"client_credentials\",\"client_id\":\"${{ secrets.SENDPULSE_CLIENT_ID }}\",\"client_secret\":\"${{ secrets.SENDPULSE_CLIENT_SECRET }}\"}" \
              | python -c "import sys, json; print(json.load(sys.stdin)['access_token'])")

            if [ -z "$SP_TOKEN" ]; then
              echo "Failed to fetch SendPulse token."
              exit 1
            fi

            for email in $USER_EMAILS; do
              curl -s -X POST "https://api.sendpulse.com/smtp/emails" \
                -H "Authorization: Bearer $SP_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{
                  \"email\": {
                    \"subject\": \"Weekly Job Digest\",
                    \"html\": \"<p>Here are jobs matching your profile</p>\",
                    \"from\": {\"name\": \"Job Alerts\", \"email\": \"${{ secrets.FROM_EMAIL }}\"},
                    \"to\": [{\"email\": \"$email\"}]
                  }
                }"
            done

            echo "Sent emails to: $USER_EMAILS"
          fi
