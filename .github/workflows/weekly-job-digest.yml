name: Weekly Job Digest

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0"  # Every Sunday

jobs:
  digest:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch Sharetribe API Token
        id: token
        run: |
          TOKEN=$(curl -s -X POST "https://flex-api.sharetribe.com/v1/auth/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials&client_id=${{ secrets.SHARETRIBE_CLIENT_ID }}&client_secret=${{ secrets.SHARETRIBE_CLIENT_SECRET }}" \
            | python -c "import sys, json; print(json.load(sys.stdin)['access_token'])")
          
          echo "TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Fetch job listings (last 7 days)
        id: jobs
        run: |
          SEVEN_DAYS_AGO=$(date -u -d "7 days ago" +"%Y-%m-%dT%H:%M:%SZ")

          JOBS=$(curl -s "https://flex-integ-api.sharetribe.com/v1/integration_api/listings/query?listingType=consultant_job&limit=100" \
            -H "Authorization: bearer $TOKEN")

          # Filter only last 7 days
          JOBS_FILTERED=$(echo "$JOBS" | jq --arg date "$SEVEN_DAYS_AGO" '
            .data |= map(select(.attributes.createdAt >= $date))
          ')

          echo "JOBS<<EOF" >> $GITHUB_ENV
          echo "$JOBS_FILTERED" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Fetch consultant profiles (approved only)
        id: consultants
        run: |
          CONSULTANTS=$(curl -s "https://flex-integ-api.sharetribe.com/v1/integration_api/listings/query?listingType=consultant_profile&limit=100" \
            -H "Authorization: bearer $TOKEN")

          CONSULTANTS_APPROVED=$(echo "$CONSULTANTS" | jq '
            .data |= map(select(.attributes.publicData.approved == "approved"))
          ')

          echo "CONSULTANTS<<EOF" >> $GITHUB_ENV
          echo "$CONSULTANTS_APPROVED" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Match jobs to consultants and get user emails
        id: match
        run: |
          JOB_ROLES=$(echo "$JOBS" | jq -r '.data[] | .attributes.publicData.role[]' | sort | uniq)

          MATCHED=$(echo "$CONSULTANTS" | jq --argjson roles "$(echo "$JOB_ROLES" | jq -R . | jq -s .)" '
            .data[] |
            select(
              (.attributes.publicData.role // []) as $cRoles |
              ($roles | any(. == $cRoles[]))
            )
          ')

          # For each matched consultant, look up user info and fetch email
          USER_EMAILS=""
          for consultant in $(echo "$MATCHED" | jq -r '.id'); do
            USER_ID=$(echo "$consultant" | jq -r '.id')
            USER_EMAIL=$(curl -s "https://flex-integ-api.sharetribe.com/v1/integration_api/users/show?id=$USER_ID" \
              -H "Authorization: bearer $TOKEN" | jq -r '.data.attributes.profile.publicData.email')

            # Add email to list if it exists
            if [ "$USER_EMAIL" != "null" ]; then
              USER_EMAILS="$USER_EMAILS $USER_EMAIL"
            fi
          done

          echo "USER_EMAILS=$USER_EMAILS" >> $GITHUB_ENV

      - name: Send emails (SendPulse)
        if: ${{ env.USER_EMAILS != '' }}
        run: |
          SP_TOKEN=$(curl -s -X POST "https://api.sendpulse.com/oauth/access_token" \
            -H "Content-Type: application/json" \
            -d "{\"grant_type\":\"client_credentials\",\"client_id\":\"${{ secrets.SENDPULSE_CLIENT_ID }}\",\"client_secret\":\"${{ secrets.SENDPULSE_CLIENT_SECRET }}\"}" \
            | python -c "import sys, json; print(json.load(sys.stdin)['access_token'])")

          for email in $USER_EMAILS; do
            curl -s -X POST "https://api.sendpulse.com/smtp/emails" \
              -H "Authorization: Bearer $SP_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{
                \"email\": {
                  \"subject\": \"Weekly Job Digest\",
                  \"html\": \"<p>Here are jobs matching your profile</p>\",
                  \"from\": {\"name\": \"Job Alerts\", \"email\": \"${{ secrets.FROM_EMAIL }}\"},
                  \"to\": [{\"email\": \"$email\"}]
                }
              }"
          done

          echo "Sent emails to: $USER_EMAILS"
